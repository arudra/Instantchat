<html>
  <head>
      <script src='/_ah/channel/jsapi'></script>
      <style type='text/css'>
        body {
          font-family: 'Helvetica';
        }

        #display-area {
          text-align: center;
        }
		
		textarea[name=msg] {
           resize: none;
        }
	
		body { 
		  background: #f0f0f0; 
		  color: #313131;
		  line-height: 1; 
		}

		/** page structure **/
		#w {
		  display: block;
		  width: 750px;
		  margin: 0 auto;
		  padding-top: 30px;
		  padding-bottom: 45px;
		}

		#content {
		  display: block;
		  width: 100%;
		  background: #fff;
		  padding: 25px 20px;
		  padding-bottom: 35px;
		  -webkit-box-shadow: rgba(0, 0, 0, 0.1) 0px 1px 2px 0px;
		  -moz-box-shadow: rgba(0, 0, 0, 0.1) 0px 1px 2px 0px;
		  box-shadow: rgba(0, 0, 0, 0.1) 0px 1px 2px 0px;
		}

		.clearfix:after { content: "."; display: block; clear: both; visibility: hidden; line-height: 0; height: 0; }
		.clearfix { display: inline-block; }
		 
		html[xmlns] .clearfix { display: block; }
		* html .clearfix { height: 1%; }
      </style>
  </head>
  <body>
    <script type='text/javascript'>
      var state = {
        chatroom_key: '{{ chatroom_key }}',
		me: '{{ me }}'
      };
	  
	  updateChat = function(msg) {
		var element = document.getElementById("chat");
		element.value += msg + "\n";
		document.getElementById("chat").scrollTop = document.getElementById("chat").scrollHeight;
      };

      sendMessage = function(path, opt_param) {
        path += '?chatroomkey=' + state.chatroom_key;
        if (opt_param) {
          path += '&' + opt_param;
        }
        var xhr = new XMLHttpRequest();
        xhr.open('POST', path, true);
        xhr.send();
      };
	  
	  sendMsg = function(msg) {
	      document.getElementById('chatmsg').value = "";
          sendMessage('/sendmsg', 'm=' + msg);
      }
	  
	  enterSend = function(event) {
		if (event.keyCode == 13)
		{
		 event.preventDefault();
          sendMsg(document.getElementById('chatmsg').value);
		}
      }

      onOpened = function() {
        sendMessage('/opened');
      };

      onMessage = function(m) {
        newState = JSON.parse(m.data);
		if (newState.msg != "")
		{
		    if (newState.msg.lastIndexOf("/",0) == 0)
			{
			  if (newState.msg.split("/")[1] == state.me + " has left the chat room.")
			  {
			    setTimeout(function(){ window.location.assign("/display"); }, 500);
		      }
			  else
			  {
			    alert(newState.msg.split("/")[1]);
			  }
			}
			else
			{
		      updateChat(newState.msg);
			}
		}
      }

      openChannel = function() {
        var token = '{{ token }}';
        var channel = new goog.appengine.Channel(token);
        var handler = {
          'onopen': onOpened,
          'onmessage': onMessage,
          'onerror': function() {},
          'onclose': function() {}
        };
        var socket = channel.open(handler);
        socket.onopen = onOpened;
        socket.onmessage = onMessage;
      }

      initialize = function() {
        openChannel();
      }

      setTimeout(initialize, 100);

    </script>
	<div id="w">
    <div id="content" class="clearfix">
    <div id='display-area'>
      <h2 style="font-family: 'WebSymbolsRegular', cursive;">Insta-Chat</h2>
	  <p><a href="javascript:sendMsg('/exit')">Leave Chat Room</a></p>
	  <p>
	  <textarea id="chatmsg" name="msg" rows="1" cols="20" onkeypress="enterSend(event)"></textarea>
	  <button id="chatsend" type="button" onclick="sendMsg(document.getElementById('chatmsg').value)" >Send</button>
	  </p>
      <textarea id="chat" rows="10" cols="100"  readonly></textarea>
    </div>
	</div>
	</div>
	
  </body>
</html>